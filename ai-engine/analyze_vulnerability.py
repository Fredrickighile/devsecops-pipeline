import numpy as np

class VulnerabilityAnalyzer:
    def __init__(self):
        self.severity_map = {
            'critical': 4,
            'high': 3,
            'medium': 2,
            'low': 1,
            'info': 0
        }
        
        self.fix_templates = {
            'dependency': 'Update package to latest secure version',
            'secret': 'Remove hardcoded credentials and use environment variables',
            'container': 'Update base image and rebuild container',
            'code-quality': 'Refactor code following security best practices',
            'configuration': 'Review and update security configuration'
        }
        
    def calculate_priority_score(self, vulnerability):
        severity = vulnerability.get('severity', 'low').lower()
        vuln_type = vulnerability.get('type', 'unknown')
        cvss = vulnerability.get('cvss', 0)
        fix_available = vulnerability.get('fixAvailable', False)
        
        severity_weight = self.severity_map.get(severity, 0) * 25
        cvss_weight = cvss * 5
        fix_penalty = -10 if fix_available else 0
        type_weight = 15 if vuln_type == 'secret' else 10
        
        priority_score = min(100, severity_weight + cvss_weight + fix_penalty + type_weight)
        
        return max(0, priority_score)
    
    def suggest_fix(self, vulnerability):
        vuln_type = vulnerability.get('type', 'unknown')
        package = vulnerability.get('package', '')
        
        base_fix = self.fix_templates.get(vuln_type, 'Review and remediate vulnerability')
        
        if package and vuln_type == 'dependency':
            return f"Update {package} to a secure version"
        
        return base_fix
    
    def estimate_effort(self, vulnerability):
        severity = vulnerability.get('severity', 'low').lower()
        fix_available = vulnerability.get('fixAvailable', False)
        
        if fix_available:
            return 'low'
        elif severity in ['critical', 'high']:
            return 'high'
        else:
            return 'medium'
    
    def analyze(self, vulnerability):
        priority_score = self.calculate_priority_score(vulnerability)
        suggested_fix = self.suggest_fix(vulnerability)
        effort = self.estimate_effort(vulnerability)
        
        risk_level = 'CRITICAL' if priority_score >= 80 else 'HIGH' if priority_score >= 60 else 'MEDIUM' if priority_score >= 40 else 'LOW'
        
        return {
            'priorityScore': round(priority_score, 2),
            'suggestedFix': suggested_fix,
            'estimatedEffort': effort,
            'riskLevel': risk_level
        }
